# 车载通信系统

车载通信网络是自动驾驶系统的神经系统，负责连接车内数百个电子控制单元（ECU）并在传感器、计算平台与执行机构之间高效传递数据。随着自动驾驶等级从 L1 向 L4/L5 演进，车内数据带宽需求从早期的数十 Mbps 急剧攀升至当前主流高算力平台所需的数十 Gbps 量级。以一辆配备 8 路摄像头、4 个固态 LiDAR 和毫米波雷达的 L4 车辆为例，仅传感器原始数据流即超过 10 Gbps，这对通信总线的吞吐量、实时性、安全性提出了前所未有的挑战。

本章系统梳理从传统车载总线到现代车载以太网、网络拓扑、中间件协议、时间敏感网络、信息安全以及 OTA 升级等关键技术，帮助读者建立完整的车载通信知识体系。


## 1. 传统车载总线

### 1.1 CAN（Controller Area Network）

CAN 总线由博世（Bosch）于 1983 年研发，1993 年被纳入 ISO 11898 标准，是目前全球装车量最大的车载总线协议。

**核心特性**

- 速率：经典 CAN 最高 **1 Mbps**（实际工程中多用 500 kbps）
- 介质访问：**CSMA/CA**（载波侦听多路访问/冲突避免），基于报文 ID 的逐位仲裁，ID 数值越小优先级越高
- 拓扑：差分双绞线总线型，两端各接 120 Ω 终端电阻
- 可靠性：含 CRC-15 校验、位填充、错误帧主动上报，具备出错节点自动隔离机制

**CAN 帧格式（标准帧）**

```
| SOF(1) | ID(11) | RTR(1) | IDE(1) | r0(1) | DLC(4) | DATA(0~64bit) | CRC(15) | ACK(2) | EOF(7) |
```

- **SOF**：帧起始，隐性→显性跳变
- **ID**：11 位（标准帧）或 29 位（扩展帧），决定报文优先级
- **DLC**：数据长度码，0~8 字节
- **CRC**：15 位循环冗余校验
- **ACK**：接收方置位确认

**典型应用**：发动机控制、制动防抱死系统（ABS）、电子稳定程序（ESP）、底盘控制域。

---

### 1.2 CAN FD（CAN with Flexible Data-Rate）

为突破经典 CAN 1 Mbps 和 8 字节的双重瓶颈，博世于 2012 年发布 CAN FD，2015 年纳入 ISO 11898-1。

**核心改进**

| 特性 | CAN 2.0 | CAN FD |
|------|---------|--------|
| 仲裁段速率 | 最高 1 Mbps | 最高 1 Mbps（保持兼容） |
| 数据段速率 | 1 Mbps | **最高 8 Mbps** |
| 最大载荷 | 8 字节 | **64 字节** |
| CRC | 15 位 | 17/21 位（更强） |
| 帧效率 | 较低 | 显著提升 |

CAN FD 在仲裁段维持与 CAN 2.0 相同的波特率，保证总线共存与优先级仲裁；仲裁成功后切换至高速数据段传输，传输完成后恢复低速。现阶段国内外主流量产车型普遍采用 CAN FD 作为动力和底盘域总线。

---

### 1.3 LIN（Local Interconnect Network）

LIN 总线于 2003 年由 LIN 联盟（Audi、BMW、Mercedes-Benz 等主导）发布，定位于低速、低成本场景。

**核心特性**

- 速率：最高 **20 kbps**
- 介质：**单线**（12V 电平），无需差分对，线束成本极低
- 架构：**主从（Master/Slave）**，仅主节点发送帧头，从节点响应；无需仲裁
- 同步：基于主节点发出的帧断路场（Break Field）进行位同步，从节点无需独立时钟

**典型应用**：车窗升降电机、座椅调节、雨刷控制、车内灯光调光等非实时低速设备，通常作为 CAN 总线的延伸子网。

---

### 1.4 FlexRay

FlexRay 于 2005 年由 FlexRay 联盟（BMW、Bosch、Daimler 等）推出，专为线控（X-by-Wire）安全关键应用设计。

**核心特性**

- 速率：每通道最高 **10 Mbps**，支持双通道冗余（合计 20 Mbps）
- 调度：**时间触发（TDMA）**，通信周期固定，延迟确定性优于 CAN
- 帧结构：静态段（确定性）+ 动态段（事件触发）混合调度
- 可靠性：双通道冗余，适合功能安全 ASIL-D 场景

**成本代价**：相比 CAN，FlexRay 节点芯片成本约高 3~5 倍，主要用于高端车型主动悬架、线控转向等场景。随着车载以太网普及，FlexRay 新项目导入量持续减少。

---

### 1.5 MOST（Media Oriented Systems Transport）

MOST 总线专为车载多媒体数据流设计，由 MOST Cooperation 维护。

**核心特性**

- 速率：MOST25（25 Mbps）、MOST50（50 Mbps）、**MOST150（150 Mbps，光纤）**
- 介质：塑料光纤（POF）或同轴铜线
- 拓扑：**环形**，数据帧沿单向传输
- 协议：同步信道（音频/视频流）+ 异步信道（数据包）+ 控制信道

**典型应用**：车载信息娱乐系统（IVI）、多媒体网关、环视摄像头图像分发。当前正逐步被车载以太网取代。

---

### 1.6 各总线综合对比

| 协议 | 最高速率 | 实时性 | 拓扑 | 线束成本 | 典型应用场景 |
|------|---------|--------|------|---------|------------|
| CAN 2.0 | 1 Mbps | 高 | 总线 | 低 | 动力/底盘控制 |
| CAN FD | 8 Mbps（数据段） | 高 | 总线 | 低 | 动力/底盘/车身 |
| LIN | 20 kbps | 中 | 主从 | 极低 | 车窗/座椅/灯光 |
| FlexRay | 10 Mbps×2 | 极高（确定性） | 双通道总线 | 高 | X-by-Wire |
| MOST150 | 150 Mbps | 中 | 环形 | 中（光纤） | 娱乐/多媒体 |
| 车载以太网 | 100M~10 Gbps | 高（TSN） | 星形/网状 | 低（单对线） | 传感器/域间骨干 |


## 2. 车载以太网（Automotive Ethernet）

传统以太网采用 4 对（或 2 对）双绞线，线束重量和 EMI 问题在车载场景难以接受。车载以太网在保留以太网协议栈的前提下，对物理层进行深度优化，实现单对双绞线传输，大幅降低线束重量和成本。

### 2.1 100BASE-T1（BroadR-Reach）

- 标准：**IEEE 802.3bw**（2015 年发布）
- 速率：**100 Mbps** 全双工
- 介质：**单对非屏蔽双绞线（UTP）**，传输距离 ≤15 m
- 调制：PAM-3（3 电平脉幅调制），节省频谱
- 典型应用：摄像头数据链路、ADAS 控制器与传感器互联

相比传统 100BASE-TX（需 2 对线），100BASE-T1 线束重量减少约 **30%**，并降低 EMI 辐射。

### 2.2 1000BASE-T1

- 标准：**IEEE 802.3bp**（2016 年发布）
- 速率：**1 Gbps** 全双工
- 介质：单对屏蔽双绞线（STP），传输距离 ≤15 m（汽车级）
- 调制：PAM-3，3 级编码
- 典型应用：域控制器间骨干链路、LiDAR 数据上传、中央计算平台互联

### 2.3 MultiGig：2.5G / 5G / 10G

随着 L4 级别传感器配置增加（高分辨率 LiDAR、4K 摄像头），骨干带宽需求超过 1 Gbps：

- **2.5GBASE-T1 / 5GBASE-T1**：过渡方案，部分芯片厂商已推出样品
- **10GBASE-T1**（IEEE 802.3ch，2020 年发布）：**10 Gbps**，单对线，目标用于计算平台内部互联及高分辨率传感器数据链路

### 2.4 带宽需求估算

以典型 L4 传感器配置为例：

```
8 路摄像头 × 1920×1080 × 30 fps × 3 字节/像素 ≈ 14.2 Gbps（未压缩）
经 H.265 压缩（30:1）后 ≈ 480 Mbps

4 路机械 LiDAR（每路 ~100 万点/秒 × 16 字节/点）≈ 512 Mbps

4 路毫米波雷达 ≈ 20 Mbps

合计（压缩后）≈ ~1 Gbps 传感器数据 + 控制/诊断流量
骨干交换链路建议 ≥ 10 Gbps
```

未压缩原始数据传输（用于感知算法直接处理）时，骨干带宽需求可达 **14 Gbps** 以上，必须采用 10GBASE-T1 或光纤方案。

### 2.5 车载以太网 vs 传统以太网

| 对比项 | 传统以太网（100BASE-TX） | 车载以太网（100BASE-T1） |
|--------|------------------------|------------------------|
| 线对数 | 2 对 | **1 对** |
| 线束重量 | 基准 | 减少约 30% |
| 传输距离 | 100 m | 15 m（满足车内需求） |
| EMI 抑制 | 标准 | 更优（PAM-3 频谱紧凑） |
| 启动时间 | 数秒 | **<500 ms**（车规要求） |
| 工作温度 | 0~70°C | **-40~125°C**（车规级） |
| 标准归属 | IEEE 802.3 | IEEE 802.3bw/bp/ch |


## 3. 车载网络拓扑

### 3.1 拓扑演进路径

**总线型（Bus Topology）**
早期分布式架构，所有 ECU 挂载在同一 CAN 总线上。优点是布线简单，缺点是带宽受限、节点增多后冲突概率上升。

**星型（Star Topology）**
以交换机或域控制器为核心节点，各 ECU 通过独享链路接入。车载以太网采用此拓扑，每节点独享带宽、互不干扰，是当前主流架构。

**环型（Ring Topology）**
MOST 总线的特征拓扑，数据单向流转，具备天然冗余但延迟固定，扩展性较差。

**混合型**
实际量产车中多种拓扑并存：CAN FD 总线连接底盘 ECU，车载以太网星型连接域控制器和传感器，LIN 作为 CAN 子网延伸至低速设备。

### 3.2 域控制器作为网关

域控制器（Domain Controller Unit, DCU）在 E/E 架构中兼任协议网关角色：

- 向下：通过 CAN FD / LIN 与各 ECU 通信
- 向上：通过车载以太网（1000BASE-T1）接入骨干交换网络
- 核心功能：协议转换、信号路由、诊断汇聚（UDS over DoIP）

### 3.3 中央计算 + 区域控制器（Zonal ECU）拓扑

特斯拉、大众 SDV（Software Defined Vehicle）等代表性方案正在向以下架构迁移：

```
                    ┌─────────────────────────────────┐
                    │       中央计算平台（CCU）         │
                    │  （高性能 SoC + 10G 以太网交换）  │
                    └──────┬──────────┬───────────────┘
                           │          │
               ┌───────────┘          └───────────────┐
               │  10GBASE-T1                10GBASE-T1 │
    ┌──────────▼──────────┐          ┌────────────────▼──────┐
    │  区域控制器 A（前区）  │          │  区域控制器 B（后区）   │
    │  （Zonal ECU）       │          │  （Zonal ECU）         │
    └──┬──────┬──────┬────┘          └──┬──────┬─────────────┘
       │      │      │                  │      │
    CAN FD  LIN  100BASE-T1          CAN FD  100BASE-T1
       │      │      │                  │      │
    制动ECU 车窗 前摄像头              驱动ECU 后摄像头/LiDAR
```

区域控制器取代传统域控制器，按物理区域（前/后/左/右）部署，减少跨车身长距离布线，线束总重量可降低 **20~30%**。

### 3.4 车载交换机（Automotive Ethernet Switch）

主流车载以太网交换机方案：

| 厂商 | 代表芯片 | 端口配置 | 特性 |
|------|---------|---------|------|
| NXP | SJA1110 | 10×100M/1G | TSN 支持，车规 AEC-Q100 |
| Marvell | 88Q5050 | 6×1G | 低延迟，AUTOSAR 集成 |
| Broadcom | BCM89881 | 8×1G + 2×10G | 高密度，支持 TSN |
| Renesas | R-Car S4 | 内置交换核 | SoC 集成，适合域控 |


## 4. SOME/IP（面向服务的中间件）

### 4.1 概述

SOME/IP（Scalable service-Oriented MiddlewarE over IP）是 AUTOSAR 定义的车载以太网服务通信协议，基于标准 UDP/TCP 传输，为 ECU 之间提供面向服务的通信接口。

### 4.2 服务发现（Service Discovery）

SOME/IP-SD 通过组播报文实现服务的动态注册与发现：

- **OfferService**：服务提供方周期性广播自身可用服务
- **FindService**：服务消费方主动查询所需服务
- **SubscribeEventgroup**：消费方向提供方订阅事件组

服务发现报文通过 **UDP 组播**（默认目标地址 224.0.0.1，端口 30490）传输，无需中央 Broker，去中心化设计适合车载分布式系统。

### 4.3 通信模式

**发布-订阅（Publish/Subscribe）**
适合周期性传感器数据（如 IMU 频率 100 Hz）：
```
传感器 ECU ──[Event Notification]──► 感知 ECU
           ──[Event Notification]──► 融合 ECU
```

**请求-响应（Request/Response）**
适合控制指令和诊断：
```
规划模块 ──[Method Call]──► 底盘控制器
                         ◄──[Response]──
```

### 4.4 序列化（Serialization）

SOME/IP 使用定长小端（Little-Endian）二进制序列化，字段顺序由 FIDL（Franca IDL）或 ARXML 接口描述文件定义，避免了 JSON/XML 的解析开销，适合嵌入式实时场景。

### 4.5 SOME/IP vs ROS2 DDS 对比

| 对比项 | SOME/IP | ROS2（DDS/DDS-XRCE） |
|--------|---------|---------------------|
| 规范来源 | AUTOSAR | OMG DDS 标准 |
| 传输层 | UDP/TCP | UDP（DDS-RTPS） |
| 服务发现 | SOME/IP-SD 组播 | DDS 内置 PDP/EDP |
| 序列化 | 二进制定长 | CDR（可选 FastBuffers） |
| QoS 配置 | 有限 | 丰富（可靠性/历史/截止时间等） |
| 车规成熟度 | 高（AUTOSAR 生态） | 中（ROS2 逐步进入量产） |
| 适用场景 | 量产 ECU 间通信 | 算法开发、仿真、研究车 |


## 5. TSN（时间敏感网络）

TSN 是 IEEE 802.1 工作组定义的一组以太网扩展标准，目标是在标准以太网上实现确定性低延迟传输，使以太网满足自动驾驶安全关键数据流的实时性要求。

### 5.1 IEEE 802.1AS：时间同步（gPTP）

广义精确时间协议（generalized Precision Time Protocol, gPTP）基于 IEEE 1588v2 简化而来，专为车载 TSN 优化：

- 同步精度：全车范围内时间偏差 **< 1 μs**（典型值 200~500 ns）
- 机制：主从层级（Grandmaster Clock → Bridge → End Stations），通过测量链路延迟并修正时间戳
- 意义：多路 LiDAR 点云融合要求各传感器时间戳对齐误差 < 1 ms，gPTP 提供必要的全局时基

### 5.2 IEEE 802.1Qbv：调度与流量整形

802.1Qbv 定义了**时间感知整形器（TAS, Time-Aware Shaper）**，将以太网传输时隙划分为门控窗口：

- 在特定时间窗口内仅允许高优先级流量（如传感器原始数据、控制指令）通过
- 确保关键帧端到端延迟有界（可达 **< 500 μs**）
- 其他流量（日志、诊断）在剩余时隙内传输，不干扰关键流

此外，**信用时基整形（CBS, Credit-Based Shaper，IEEE 802.1Qav）** 通过令牌桶机制平滑突发流量，防止队列拥塞。

### 5.3 IEEE 802.1Qci：流过滤与监管（PSFP）

每流过滤和监管（Per-Stream Filtering and Policing）：

- 对每条数据流独立施加速率限制和过滤规则
- 丢弃超出约定流量规格的帧，防止异常节点（含受攻击节点）占用带宽
- 结合信息安全，可作为第一道网络入侵防护

### 5.4 TSN 在自动驾驶中的典型应用

| 应用场景 | TSN 作用 |
|---------|---------|
| LiDAR 点云时间对齐 | gPTP 提供全局时间戳，点云拼接误差 < 1 ms |
| 摄像头帧同步 | 触发信号通过 TSN 同步，消除多摄像头时差 |
| 线控指令下发 | TAS 保障控制帧 < 500 μs 端到端延迟 |
| 域间骨干传输 | CBS 防止高带宽视频流冲击控制流 |
| 系统级调度 | 与 AUTOSAR Adaptive 调度框架协同 |


## 6. 信息安全（Automotive Cybersecurity）

### 6.1 ISO/SAE 21434 标准框架

ISO/SAE 21434《道路车辆——网络安全工程》（2021 年发布）定义了车载网络安全的完整工程方法论：

- **TARA（威胁分析与风险评估）**：识别攻击面，量化安全风险等级（CAL 1~4）
- **安全开发生命周期**：覆盖概念设计、产品开发、生产、运营、报废各阶段
- **监控与响应**：要求 OEM 建立 VSOC（车辆安全运营中心）持续监测在网车辆

### 6.2 SecOC（Secure Onboard Communication）

SecOC 是 AUTOSAR 定义的车内安全通信规范，通过在 PDU（协议数据单元）中附加消息认证码（MAC）防止报文篡改和伪造：

```
原始数据 PDU
│
▼
[数据 | FreshnessValue（新鲜值）] ──► CMAC/HMAC 计算（AES-128）
│
▼
安全 PDU = [数据 | FreshnessValue截断 | MAC截断]
```

- **新鲜值（Freshness Value）**：防止重放攻击，通常基于单调计数器或时间戳
- **MAC 算法**：AUTOSAR 推荐 AES-128-CMAC，截断至 24~64 位以控制帧长开销
- **性能开销**：HSM（硬件安全模块）加速下，单帧 MAC 计算时延 < 10 μs

### 6.3 OTA 安全更新

OTA（Over-The-Air）软件升级是 SDV 的核心能力，安全机制包括：

**代码签名验证**：软件包由 OEM 私钥签名，ECU 侧使用存储在 HSM 中的 OEM 公钥验证，防止安装恶意固件。

**分发信道加密**：云端→TCU 采用 TLS 1.3，TCU→域控采用 MACsec（IEEE 802.1AE）加密以太网帧。

**回滚保护**：ECU 中存储当前固件版本的防回滚计数器（Anti-Rollback Counter），更新版本号只能递增，防止攻击者降级至含已知漏洞的旧版本。

### 6.4 入侵检测系统（IDS/IPS）

车载 IDS 部署策略：

- **基于规则**：检测异常报文（如 CAN ID 发送频率骤增、以太网端口扫描）
- **基于基线异常**：建立正常通信基线（时序、流量），检测偏离行为
- **部署位置**：车载以太网交换机（镜像端口监听）、域控制器（网关过滤）
- **响应机制（IPS）**：隔离异常 ECU（断开以太网端口）、降级工作模式、上报 VSOC

主流车载 IDS 方案商包括 Upstream Security、Argus Cyber Security（大陆集团）、Vector（CANoe IDS 插件）等。


## 7. OTA 空中升级架构

### 7.1 软件分发流程

完整 OTA 链路从云端到 ECU 经过多级节点：

```
OEM 云端
后端服务器
    │  TLS 1.3 + 代码签名包
    ▼
车载 TCU（Telematics Control Unit）
（4G/5G 蜂窝接收，缓存完整软件包）
    │  MACsec 加密以太网
    ▼
域控制器 / 中央计算平台
（软件包验证、解压、分发调度）
    │  CAN FD / 车载以太网
    ▼
目标 ECU
（UDS 协议：0x34 RequestDownload / 0x36 TransferData / 0x37 RequestTransferExit）
```

**UDS（ISO 14229）**是 ECU 固件更新的标准应用层协议，`0x34`~`0x37` 服务组合完成固件块传输，可在车载以太网（DoIP）或 CAN（ISO-TP 分段）上承载。

### 7.2 A/B 双分区更新

A/B 分区（也称 Slot A/Slot B 或 Active/Inactive Partition）是防止刷机失败导致 ECU 变砖的核心机制：

```
Flash 存储器
┌──────────────┬──────────────┬──────────┐
│  分区 A（当前 │  分区 B（备用 │ Bootloader│
│  运行固件）  │  新固件写入）│（不可更新）│
└──────────────┴──────────────┴──────────┘

更新流程：
1. 新固件写入分区 B，计算并验证哈希
2. Bootloader 设置"待切换"标志
3. ECU 重启，Bootloader 从分区 B 启动
4. 新固件自检通过 → 确认切换，分区 B 成为新主分区
   新固件自检失败 → 自动回退至分区 A
```

### 7.3 差分升级（Differential Update）

全量固件包动辄数百 MB，消耗大量蜂窝流量。差分升级仅传输新旧版本之间的**增量二进制差分**：

- 工具链：bsdiff/bspatch（字节级差分）、HDIFFPATCH（块级差分，适合大文件）
- 压缩率：典型固件版本间差异率 5~15%，差分包体积可降低至全量包的 **10~20%**
- 适用条件：ECU 具备足够 RAM 进行在线 patch 重建，或具备独立 scratch 分区

### 7.4 更新期间的功能安全保障

OTA 更新不得危及行车安全，需满足：

- **仅在安全状态下更新**：ECU 通过车速、挡位、点火状态判断，仅在车辆停止且驻车制动接合时执行关键 ECU（制动、转向）更新
- **更新隔离**：更新过程中保持冗余 ECU 接管，满足 ASIL-D 功能安全等级（ISO 26262）的诊断覆盖率要求
- **时间窗口管理**：避免在高温、低电量等极端条件下启动更新，防止中断
- **回滚可追溯**：每次更新记录版本号、时间戳、成功/失败状态，上传 VSOC 供远程审计


## 8. 参考资料

1. ISO 11898-1:2015. *Road vehicles — Controller area network (CAN) — Part 1: Data link layer and physical coding sublayer*. International Organization for Standardization.
2. IEEE 802.3bw-2015 / 802.3bp-2016 / 802.3ch-2020. *IEEE Standard for Ethernet — Automotive Ethernet Physical Layer Specifications*. IEEE.
3. AUTOSAR Consortium. *SOME/IP Protocol Specification* (Release 22-11). https://www.autosar.org.
4. IEEE 802.1AS-2020. *Timing and Synchronization for Time-Sensitive Applications*. IEEE; 以及 IEEE 802.1Qbv-2015. *Enhancements for Scheduled Traffic*. IEEE.
5. ISO/SAE 21434:2021. *Road Vehicles — Cybersecurity Engineering*. International Organization for Standardization / SAE International.
