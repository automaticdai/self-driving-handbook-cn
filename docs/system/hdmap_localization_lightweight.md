# 地图定位与轻图路线：融合、降级与工程挑战

本页关注地图在定位与规划中的使用方式，以及"轻地图/无图"路线的技术边界与工程挑战。

---

## 1. 地图辅助定位原理

### 1.1 定位问题的本质

自动驾驶定位的目标是实时估计车辆在地图坐标系中的精确位姿：

$$\text{Pose} = \{x, y, z, \text{roll}, \text{pitch}, \text{yaw}\}$$

单纯依靠 GNSS 的精度（标准定位 1–5 m）远不足以实现车道级定位（< 20 cm）。地图作为先验知识，与实时传感器结合可显著提升定位精度。

### 1.2 LiDAR 地图匹配

**NDT 地图匹配流程：**

1. 预先建立 NDT 地图（将全局点云体素化，每格建高斯分布）
2. 实时 LiDAR 扫描与 NDT 地图配准
3. 优化变换矩阵：

$$T^* = \arg\max_T \sum_{p \in \text{scan}} p_\text{ndt}(T \cdot p)$$

4. 输出当前位姿与匹配置信度

**ICP 地图匹配：**

相比 NDT，ICP 对初始值更敏感，但在特征丰富场景（如室内或结构清晰的建筑旁）精度更高。

**工程优化：**

```
优化方向：
  ├─ 多分辨率 NDT：粗→细，加速收敛
  ├─ 点云预处理：地面滤除，降低干扰
  ├─ ROI 裁剪：只匹配车辆周围 50 m 内的地图
  └─ GNSS 提供初始位姿猜测，缩小搜索范围
```

### 1.3 视觉特征地图匹配

**特征地图（Feature Map）：**

- 建图阶段提取稳定的视觉特征点（ORB/SuperPoint）
- 为每个特征点存储 3D 坐标和描述子
- 定位时：特征匹配 → PnP 求解位姿

**语义地标匹配：**

使用高层语义元素（路灯、道路标志、人行横道线）作为定位锚点：

- 高层语义比低层特征点更稳定（不受光照、季节变化影响）
- 精度较低（30–100 cm），但覆盖范围更广

### 1.4 概率定位框架

**粒子滤波（Particle Filter）：**

$$p(\mathbf{x}_t | \mathbf{z}_{1:t}, \mathbf{u}_{1:t}) \approx \sum_{i=1}^N w_i^{(t)} \delta(\mathbf{x} - \mathbf{x}_i^{(t)})$$

通过维护一组粒子（每个粒子代表一个可能的位姿假设），通过运动更新和观测更新迭代估计位姿分布。

优点：可处理多模态分布（定位歧义场景）；缺点：粒子数量与精度的权衡，高精度需要大量粒子。

---

## 2. 多传感器融合定位架构

### 2.1 典型融合架构

```
GNSS 全局约束
    │
    ├─ 紧耦合 GNSS/IMU（高频，50–200 Hz）
    │   提供粗粒度全局位置和姿态
    │
    ├─ LiDAR 地图匹配（10–20 Hz）
    │   提供精确 3D 位置约束
    │
    ├─ 视觉里程计（10–30 Hz）
    │   提供短时精确相对位移
    │
    └─ 因子图融合（全局优化）
        输出：高频（50 Hz+）精确位姿估计
```

### 2.2 权重自适应机制

各传感器的融合权重根据实时质量评估动态调整：

```python
def compute_fusion_weights(gnss_quality, lidar_score, vo_score):
    """
    返回归一化融合权重
    """
    weights = {
        'gnss': gnss_quality * W_GNSS_BASE,
        'lidar': lidar_score * W_LIDAR_BASE,
        'visual': vo_score * W_VO_BASE
    }
    # 归一化
    total = sum(weights.values())
    return {k: v / total for k, v in weights.items()}
```

---

## 3. 地图质量对定位的影响

### 3.1 精度-时效性分析

```
地图采集时间（月前）
    ↑
0   │████ 高精度，低误差
1   │████ 少量变化
3   │███░ 局部失配（施工、标志变更）
6   │██░░ 较多区域失配
12  │█░░░ 显著退化（城区）
    └──────────────────→ 定位误差
```

城区变化快，地图时效性要求高（月级或周级更新）；
高速公路变化少，季度更新可接受。

### 3.2 地图失配对定位的影响

| 失配类型 | 匹配残差变化 | 定位误差影响 |
| --- | --- | --- |
| 新增障碍物（临时锥桶）| 小幅上升 | 轻微 |
| 路面标线重新划定 | 中等上升 | 中等（10–50 cm） |
| 道路改道 | 大幅上升 → 配准失败 | 严重（可能跳变） |
| 建筑物拆除 | 中等上升 | 中等 |

---

## 4. 地图失效与降级

### 4.1 地图健康度评分

设计统一的地图健康度评分驱动降级决策：

```
map_health_score = α × match_score + β × timeliness_score + γ × coverage_score

match_score:      当前配准残差（越低越好）
timeliness_score: 地图距上次更新的时间（越新越好）
coverage_score:   当前区域地图覆盖完整度

α + β + γ = 1，按场景调整权重
```

### 4.2 降级路径

```
map_health_score
    │
    ├─ > 0.8：正常运行，地图先验权重正常
    │
    ├─ 0.5–0.8：
    │   ├─ 降低地图先验权重（提升实时感知权重）
    │   ├─ 限速（城区 40 km/h，高速 80 km/h）
    │   └─ 禁止自动变道，使用感知主导轨迹
    │
    ├─ 0.3–0.5：
    │   ├─ 触发重定位（主动搜索全局匹配）
    │   ├─ 发送 TOR 预警（非紧急）
    │   └─ 切换至最保守驾驶模式
    │
    └─ < 0.3：
        ├─ 地图失效判定
        ├─ 触发 TOR（紧急）
        └─ 执行 MRC
```

---

## 5. 轻地图路线

### 5.1 技术定义

"轻地图"（Lightweight Map / Sparse Map）不等于"没有地图"，而是以更低成本的地图覆盖核心功能需求：

| 信息层 | 完整 HD Map | 轻地图 |
| --- | --- | --- |
| 道路拓扑骨架 | ✓ | ✓（保留）|
| 车道几何（厘米级）| ✓ | △（降精度）|
| 语义元素（停止线等）| ✓ | △（关键路口保留）|
| 定位特征点 | ✓ | ✗ |
| 依赖实时感知 | 低 | 高 |

### 5.2 典型实现策略

**策略一：道路拓扑 + 关键语义**

保留：路口连接关系、限速、关键停止线
依赖感知：车道边界、动态障碍物、实时几何

**策略二：众包轻图（Crowd-sourced Map）**

- 量产车辆行驶中提取道路骨架
- 用大量用户数据众包生成稳定的轻量语义地图
- Mobileye REM（Road Experience Management）是典型代表

**策略三：语义先验地图**

- 只存储高层语义信息（路口类型、限速区域、关键地标）
- 实时感知负责填补细节，地图提供结构化约束

### 5.3 优缺点分析

| 维度 | 完整 HD Map | 轻地图 |
| --- | --- | --- |
| 采集成本 | 极高（专业采集车） | 中（部分众包）|
| 更新速度 | 慢（天–周级）| 快（实时众包）|
| 感知依赖 | 低（地图提供先验）| 高（感知承担更多）|
| 长尾风险 | 低（地图覆盖边界）| 高（感知不确定性增加）|
| ODD 覆盖 | 受采集区域限制 | 理论上更广 |

---

## 6. 无图路线的边界

"无图"并非真正无先验知识，而是最小化对预先构建地图的依赖。

### 6.1 仍然需要的先验

即使是"无图"方案，也离不开：

| 先验类型 | 作用 |
| --- | --- |
| 基础导航地图 | 全局路由规划 |
| 交通规则数据库 | 限速、信号灯逻辑 |
| 高层地理信息 | 区域特征（城区/高速/乡道）|
| 在线实时数据 | 交通状况、临时管制 |

### 6.2 主要挑战

```
无图路线的核心挑战：
  ├─ 车道级定位：无地图先验时，仅靠感知定位精度有限
  ├─ 长尾场景：不熟悉区域的复杂路口处理能力下降
  ├─ 遮挡与能见度：感知不确定性无法被地图先验弥补
  └─ 安全余量收紧：系统需要比"有图"时更保守的速度策略
```

### 6.3 行业代表案例对比

| 公司/系统 | 地图策略 | 核心能力 |
| --- | --- | --- |
| Waymo | 完整 HD Map，精细建图 | 特定区域超高精度，ODD 明确 |
| Tesla FSD | 仅 SD Map，轻语义先验 | 泛化能力强，新区域快速扩展 |
| Mobileye | REM 轻图，众包更新 | 大规模 ADAS，成本低 |
| Cruise | HD Map + 本地特征 | 特定城市深度运营 |

---

## 7. 定位与规划接口设计

### 7.1 定位输出对规划的影响

规划层直接消费定位输出，接口质量至关重要：

```yaml
localization_to_planning:
  pose:           # 6-DOF 位姿
  confidence:     # 置信度（影响规划的安全余量）
  mode:           # NORMAL/DEGRADED（影响是否允许高速变道）
  map_match_score:# 地图匹配质量（影响是否依赖地图语义）
  uncertainty:    # 位置协方差矩阵（影响轨迹规划的安全边界膨胀）
```

### 7.2 安全余量自适应

```python
def compute_safety_margin(localization_confidence, map_health):
    base_margin = 0.3  # 基础安全余量（米）

    # 定位不确定性增加余量
    loc_factor = (1 - localization_confidence) * 0.5
    # 地图健康度不足增加余量
    map_factor = (1 - map_health) * 0.3

    return base_margin + loc_factor + map_factor
```

---

## 8. 评估指标建议

| 指标 | 定义 | 目标值 |
| --- | --- | --- |
| 地图匹配成功率 | 配准收敛且残差 < 阈值的帧比例 | > 99% |
| 定位横向误差 P95 | 95% 时刻的横向定位误差 | < 15 cm |
| 地图失效触发率 | 每万公里触发地图降级的次数 | < 5 次/万公里 |
| 降级后任务完成率 | 地图降级期间的任务完成比例 | > 95% |
| 地图更新响应时间 | 从道路变化到地图更新完成 | < 24h（城区热点）|

---

## 9. 实践建议

1. **统一健康度分数驱动"地图权重自适应"**：避免硬编码"有地图/无地图"二元逻辑
2. **在高变化区域优先做高频增量更新**：施工频繁路段每天更新，而非月度更新
3. **把地图问题纳入算法回归集**：地图版本更新时需要同步运行定位回归，确认匹配质量不下降
4. **建立地图降级对安全指标的影响模型**：量化"地图健康度下降 X%"对接管率的影响
5. **为规划层暴露地图可信度**：让规划知道当前地图质量，动态调整行驶策略
