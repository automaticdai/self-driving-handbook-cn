# 纵向控制：跟驰、制动与舒适性

纵向控制负责速度、车距和停车过程，直接影响行车安全与乘坐体验。

---

## 1. 纵向动力学模型

### 1.1 纵向受力分析

车辆纵向运动方程：

$$m\dot{v} = F_{drive} - F_{drag} - F_{roll} - F_{grade}$$

各阻力分量：

$$F_{drag} = \frac{1}{2}\rho C_D A v^2 \quad \text{（空气阻力）}$$

$$F_{roll} = f_r m g \cos\theta \quad \text{（滚动阻力）}$$

$$F_{grade} = m g \sin\theta \quad \text{（坡度阻力，上坡为正）}$$

其中 $C_D$ 为风阻系数，$A$ 为迎风面积，$f_r$ 为滚动阻力系数，$\theta$ 为坡度角。

### 1.2 加速度控制模型

工程上通常将底层执行器抽象为"加速度执行器"，控制器输出期望加速度 $a_{\text{cmd}}$，底层通过驱动/制动力反算：

$$F_{\text{cmd}} = m \cdot a_{\text{cmd}} + F_{drag}(v) + F_{roll} + F_{grade}$$

!!! note "坡度估计"
    实车中坡度 $\theta$ 一般通过 IMU 俯仰角估计，或通过高精地图先验。坡度估计误差直接影响坡道起步和停车的平顺性。

---

## 2. PID 纵向控制

### 2.1 速度跟踪 PID

基础结构：前馈 + 反馈双环设计：

$$a_{\text{cmd}} = a_{\text{ff}} + K_p e_v + K_i \int e_v \, dt + K_d \dot{e}_v$$

其中 $e_v = v_{\text{ref}} - v$ 为速度误差，前馈项 $a_{\text{ff}}$ 可由参考轨迹加速度直接获取。

**抗积分饱和（Anti-Windup）：**

当控制量达到限幅时停止积分，防止积分项过大：

```python
# 伪代码
if abs(a_cmd) >= a_max:
    integrator_hold = True  # 停止积分
else:
    integrator_hold = False
```

### 2.2 参数调整建议

| 参数 | 增大效果 | 减小效果 |
| --- | --- | --- |
| $K_p$ | 响应更快，可能超调 | 响应慢，稳态误差大 |
| $K_i$ | 消除稳态误差更快 | 积分作用弱 |
| $K_d$ | 抑制超调，增加阻尼 | 对噪声敏感（需滤波） |

---

## 3. 自适应巡航控制（ACC）

### 3.1 时距策略

ACC 核心是在跟车时维持安全时距 $T_{gap}$：

$$d_{\text{safe}} = T_{gap} \cdot v + d_0$$

其中 $d_0$ 为静止时最小间距（通常 2–5 m），$T_{gap}$ 通常设置 1.5–2.5 s（可用户调节）。

### 3.2 跟车控制律

常用间距-速度联合控制：

$$a_{\text{cmd}} = k_1(v_{\text{lead}} - v) + k_2(d - d_{\text{safe}})$$

其中：

- $k_1$：速度差增益（相当于对前车速度的前馈）
- $k_2$：间距误差增益（调节跟车距离的收敛速度）

**IDM 模型（Intelligent Driver Model）：**

$$a = a_{\max}\left[1 - \left(\frac{v}{v_0}\right)^4 - \left(\frac{d^*(v, \Delta v)}{d}\right)^2\right]$$

$$d^* = d_0 + vT + \frac{v\Delta v}{2\sqrt{a_{\max}b}}$$

IDM 模型在学术界广泛使用，参数少且行为符合直觉，适合作为 ACC 基线方案。

### 3.3 Cut-in 响应

前车突然切入时的处理策略：

1. **快速识别**：感知层及时输出 cut-in 目标（通常 200 ms 内）
2. **间距重规划**：立即计算新目标时距，避免过激制动
3. **渐进响应**：对期望加速度做斜率限制，防止乘客体感突变

---

## 4. 制动控制

### 4.1 制动力分配

电动车通常采用"再生制动优先，摩擦制动补充"策略：

```
期望制动力 F_brake
    │
    ├─ 若 |F_brake| ≤ F_regen_max：全部由电机回收
    │
    └─ 若 |F_brake| > F_regen_max：
           F_friction = F_brake - F_regen_max
           同时激活摩擦制动
```

低附着路面（雪地、湿滑）：触发 ABS，制动优先，限制再生制动比例。

### 4.2 AEB 制动时序

| 环节 | 典型时间 | 优化方向 |
| --- | --- | --- |
| 感知输出延迟 | 50–80 ms | 提升感知帧率，减少处理时延 |
| 规划决策延迟 | 10–30 ms | 专用 AEB 路径，绕过完整规划栈 |
| 控制下发延迟 | 1–5 ms | 高频控制环 |
| 执行器建压时间 | 50–150 ms | EHB/EMB 选型关键指标 |
| **全链路总计** | **~150 ms** | 目标 < 150 ms（NCAP 要求） |

!!! warning "AEB 误触发"
    AEB 误触发会严重影响用户体验甚至造成追尾事故。需要对感知置信度门控，并设置"白名单"（隧道假目标、路面积水、桥墩阴影等）。

### 4.3 坡道起步控制

避免坡道后溜需要与 EPB（电子驻车制动）或 Auto Hold 联动：

1. 驾驶员松脚刹 → 触发 Auto Hold
2. 检测到驾动意图（油门踩下/扭矩请求）
3. 计算当前坡度所需最小驱动力
4. 驱动力超过阈值后，延时 200–300 ms 才释放 Auto Hold

---

## 5. 纵向 MPC

### 5.1 预测模型

以加速度为控制量，状态为位置和速度：

$$\begin{bmatrix} s_{k+1} \\ v_{k+1} \end{bmatrix} = \begin{bmatrix} 1 & \Delta t \\ 0 & 1 \end{bmatrix} \begin{bmatrix} s_k \\ v_k \end{bmatrix} + \begin{bmatrix} \frac{\Delta t^2}{2} \\ \Delta t \end{bmatrix} a_k$$

### 5.2 代价函数

$$J = \sum_{k=0}^{N-1} \left[ w_v(v_k - v_{\text{ref}})^2 + w_s(s_k - s_{\text{ref}})^2 + w_a a_k^2 + w_j(a_k - a_{k-1})^2 \right]$$

各权重含义：

- $w_v$：速度跟踪精度
- $w_s$：车距保持精度
- $w_a$：加速度惩罚（舒适性）
- $w_j$：jerk 惩罚（平顺性）

---

## 6. 舒适性设计

### 6.1 关键约束

| 舒适性指标 | 建议上限 | 说明 |
| --- | --- | --- |
| 纵向加速度 | ±3 m/s² | 超过 4 m/s² 乘客明显不适 |
| 纵向 jerk | ±2 m/s³（常规），±5 m/s³（紧急） | jerk 是乘坐体验的直接感受量 |
| 急刹频次 | < 0.5 次/百公里 | 主观体验关键指标 |

### 6.2 速度曲线平滑

对规划输出的速度曲线做平滑处理，避免急速变化：

```python
# 限制 jerk（对加速度做斜率限制）
a_cmd = a_cmd_raw
delta_a = a_cmd - a_prev
delta_a_clipped = clip(delta_a, -jerk_max * dt, jerk_max * dt)
a_cmd = a_prev + delta_a_clipped
```

---

## 7. 典型失效场景

| 场景 | 描述 | 应对策略 |
| --- | --- | --- |
| 前车突然 cut-in | 感知突然引入新目标 | 渐进响应，限制 jerk |
| 坡道起步后溜 | 松刹后短暂下滑 | EPB/Auto Hold 联动 |
| 低附着急刹 | 冰雪路面刹车距离显著增大 | 限制期望减速度，联动稳定控制系统 |
| 感知丢失前车 | 障碍物消失导致突然加速 | 设置"丢失超时"保持策略，不立即松开 |
| 隧道内 GNSS 失效 | 速度曲线规划精度下降 | 切换保守恒速模式，提升感知主导权重 |

---

## 8. 评估指标

| 指标 | 说明 | 参考目标 |
| --- | --- | --- |
| 速度误差 RMS | 巡航场景稳态精度 | < 0.5 km/h |
| 时距达标率 | 跟车间距满足目标时距的占比 | > 95% |
| 峰值减速度 | 急制动性能 | 满足 NCAP 标准 |
| 峰值 jerk | 舒适性核心指标 | < 5 m/s³（非紧急） |
| 急刹触发率 | 每百公里 jerk > 4 m/s³ 的次数 | < 1 次 |
| 坡道后溜距离 | 起步时最大后溜量 | < 20 cm |
