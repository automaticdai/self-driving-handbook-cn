# HD Map 数据与生命周期：格式、采集、更新与版本治理

本页聚焦高精地图从生产到上线的完整生命周期，涵盖数据规格、格式选型、采集生产流程与版本治理。

---

## 1. 高精地图数据规格

### 1.1 精度要求

高精地图（HD Map）与导航地图（SD Map）的核心区别在于精度和语义丰富度：

| 属性 | 导航地图 | 高精地图 |
| --- | --- | --- |
| 车道几何精度 | 米级（1–5 m） | 厘米级（5–20 cm） |
| 语义信息 | 路名、POI | 车道边界、停止线、信号灯 |
| 更新频率 | 月/季度 | 天/周（热点区域） |
| 数据量（每公里）| KB 级 | MB 级 |
| 用途 | 导航规划 | 车道级定位、轨迹规划 |

### 1.2 数据层次

| 层次 | 内容示例 | 用途 |
| --- | --- | --- |
| 道路层 | 路段几何、连接关系、等级 | 全局拓扑路由 |
| 车道层 | 车道边界线、中心线、可变车道 | 车道级规划 |
| 语义层 | 限速、停止线、斑马线、信号灯位置 | 行为决策 |
| 属性层 | 施工标志、潮汐车道、临时管制 | 动态约束 |
| 定位层 | 地标特征点、反射强度图 | 激光/视觉定位 |

---

## 2. 地图格式详解

### 2.1 OpenDRIVE

OpenDRIVE 是仿真和研究领域广泛使用的开放格式（ASAM 标准）。

**核心结构（XML）：**

```xml
<OpenDRIVE>
  <road name="MainRoad" length="500.0" id="1" junction="-1">
    <planView>
      <geometry s="0" x="100" y="200" hdg="1.57" length="100">
        <line/>   <!-- 或 <arc curvature="0.01"/>、<spiral/> -->
      </geometry>
    </planView>
    <lanes>
      <laneSection s="0">
        <left>
          <lane id="1" type="driving" level="false">
            <width sOffset="0" a="3.5" b="0" c="0" d="0"/>
            <roadMark .../>
          </lane>
        </left>
      </laneSection>
    </lanes>
    <signals>
      <signal s="50" t="2" id="sig1" type="1000001" .../>
    </signals>
  </road>
  <junction id="10">
    <connection id="0" incomingRoad="1" connectingRoad="2">
      <laneLink from="-1" to="-1"/>
    </connection>
  </junction>
</OpenDRIVE>
```

**特点：** 参数化道路几何（直线/圆弧/欧拉螺线），仿真场景构建能力强；车道级语义丰富；但不原生支持地图分块，大规模路网管理需要额外处理。

### 2.2 Lanelet2

Lanelet2 是一个面向自动驾驶应用的开源地图格式（基于 OSM）：

**核心概念：**

```
Point (3D 点)
  └─ Linestring（线段序列）
      ├─ Lanelet（一对左右边界 Linestring + 交通规则）
      │   ├─ left: Linestring
      │   ├─ right: Linestring
      │   └─ regulatory_elements: [速度限制, 信号灯, 停止线]
      └─ Area（区域，如路口、停车场）
```

**优势：** 开源活跃，ROS 2 原生支持；与 Autoware 深度集成；适合研究与快速原型。

### 2.3 NDS（Navigation Data Standard）

NDS 是车载导航产业联盟（NDS Association）制定的商用格式：

- 分块（Tile）存储，按需加载
- 加密保护，适合商业发布
- 在欧系和日系 OEM 导航中广泛应用
- NDS.Live：面向 ADAS 和 AD 的扩展标准

### 2.4 格式选型建议

| 场景 | 推荐格式 |
| --- | --- |
| 仿真场景构建 | OpenDRIVE |
| 研究/Autoware开发 | Lanelet2 |
| 商用车机导航 | NDS |
| 量产自驾系统 | 厂商私有格式（与工具链深度绑定）|

---

## 3. 地图采集与生产流程

### 3.1 采集车配置

```
采集车传感器套件（典型配置）：
  ├─ 高精 GNSS/IMU（后处理 RTK，精度 2–5 cm）
  ├─ 旋转式 LiDAR × 2–4（360° 覆盖）
  ├─ 工业相机 × 8（360°，高分辨率）
  ├─ 地面特征相机（向下，道路标线）
  └─ 车速传感器（里程计）
```

### 3.2 离线处理流程

```
原始采集数据
    │
    ↓ 轨迹后处理（PPK/PPP 精化）
精确参考轨迹（精度 < 5 cm）
    │
    ↓ 点云拼接（NDT/ICP 全局对齐）
全局点云地图
    │
    ↓ 点云分割（地面/建筑/植被/路面要素）
语义点云
    │
    ├─→ 道路层提取（路沿检测、道路边界）
    ├─→ 车道层提取（车道线检测、中心线生成）
    └─→ 语义层提取（停止线、标志、信号灯）
    │
    ↓ 人工质检与规则校验
最终地图数据
```

### 3.3 AI 辅助生产

传统人工标注效率低，现代生产流程引入 AI 加速：

| 生产环节 | 传统方式 | AI 辅助方式 | 效率提升 |
| --- | --- | --- | --- |
| 车道线提取 | 人工描点 | 语义分割模型 | 10–20× |
| 停止线识别 | 人工标注 | 目标检测 | 10× |
| 信号灯关联 | 人工逐一确认 | 几何约束+AI | 5× |
| 拓扑关系构建 | 人工建图 | 图神经网络辅助 | 3× |

---

## 4. 质量检验

### 4.1 自动校验规则

```python
# 拓扑一致性检查示例
def check_topology(lanelet_map):
    errors = []
    for lanelet in lanelet_map.laneletLayer:
        # 检查相邻车道连接连续性
        for follower in routing_graph.following(lanelet):
            if not is_geometrically_connected(lanelet, follower, tol=0.5):
                errors.append(f"GAP: {lanelet.id} -> {follower.id}")

        # 检查车道宽度合理性
        width = compute_width(lanelet)
        if width < 2.0 or width > 6.0:
            errors.append(f"WIDTH_ANOMALY: {lanelet.id}, width={width:.2f}m")
    return errors
```

### 4.2 人工质检重点

- **几何精度验证**：在控制点处检验地图与实测的横向误差
- **语义完整性**：路口停止线、让行线、信号灯覆盖率
- **拓扑一致性**：路口连接关系、可变车道逻辑
- **交叉验证**：不同采集批次的重叠区域一致性

### 4.3 质量指标

| 指标 | 定义 | 目标值 |
| --- | --- | --- |
| 车道几何误差 | 中心线与真实车道中心的横向误差 | RMS < 10 cm |
| 语义完整率 | 已标注语义元素 / 应标注元素总数 | > 98% |
| 拓扑一致率 | 拓扑关系无误的路口比例 | > 99.5% |
| 采集到可用时长 | 从采集完成到车端可用的天数 | < 3 天（增量更新） |

---

## 5. 更新与发布

### 5.1 全量更新 vs 增量更新

| 类型 | 触发场景 | 包大小 | 风险 |
| --- | --- | --- | --- |
| 全量更新 | 基线版本迭代，格式变更 | 大（GB 级）| 需要完整验证 |
| 增量更新 | 局部施工、热点区域修复 | 小（MB 级）| 快速部署，验证简单 |

### 5.2 灰度发布策略

```
地图增量包准备
    │
    ↓ 内部测试（采集车 + 10 辆测试车）
验证定位一致性（匹配残差无上升）
    │
    ↓ 5% 区域车辆灰度推送
监控 24 小时（接管率、定位残差）
    │
    ↓ 指标正常 → 全量推送
    │ 指标异常 → 回滚到上一版本
```

---

## 6. 版本治理

### 6.1 版本号规范

```
地图版本格式：
  {区域代码}_{年月}_{序号}_{更新类型}

示例：
  BJ_202503_001_INCR    （北京，2025年3月，第1次增量更新）
  SHA_202504_001_FULL   （上海，2025年4月，全量更新）
```

### 6.2 依赖兼容性管理

地图版本更新需要与算法版本做兼容性校验：

```yaml
compatibility_matrix:
  map_v2.5.x:
    - localization: ">=2.3.0"
    - planning: ">=3.1.0"
  map_v3.0.0:  # 格式变更，需要更高版本
    - localization: ">=2.5.0"
    - planning: ">=3.5.0"
```

### 6.3 回滚机制

- 车端始终保留最近 2 个稳定地图版本
- 出现定位异常时，可通过 OTA 指令在 5 分钟内回滚
- 地图版本变更记录永久归档，支持审计追溯

---

## 7. 地图安全

### 7.1 数据安全

- **加密存储**：地图数据 AES-256 加密存储，防止泄露
- **访问控制**：基于车辆证书的地图授权（授权区域、有效期）
- **传输安全**：TLS 1.3 加密传输

### 7.2 数据隐私

采集车在公共道路采集数据时需要处理隐私问题：

- 行人/车牌在数据上云前自动模糊
- 采集轨迹脱敏（去除时间戳关联）
- 满足 GDPR 和国内数据安全法规要求

---

## 8. 采集成本优化

### 8.1 众包更新

利用量产车队众包采集地图变化：

```
量产车辆（已部署感知）
    │ 识别到道路变化（新施工、新标志）
    │ 上报变化片段（匿名化、脱敏）
    ↓
云端汇聚 + 变化检测
    │ 超过 N 辆车报告同一位置异常
    ↓
触发采集车前往核实 + 更新地图
```

众包可将地图更新响应时间从"按计划"缩短到"按需求"。

### 8.2 成本构成与优化方向

| 成本项 | 占比 | 优化方向 |
| --- | --- | --- |
| 采集车运营 | ~40% | 众包替代，提高采集效率 |
| 数据处理（算力）| ~20% | AI 自动化，降低人工介入 |
| 质检人力 | ~25% | 提高 AI 质检覆盖率 |
| 存储与分发 | ~15% | 增量更新压缩，CDN 优化 |
